C51 COMPILER V9.52.0.0   LCD1602                                                           01/05/2018 12:35:22 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE LCD1602
OBJECT MODULE PLACED IN lcd1602.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE source\lcd1602.c ROM(COMPACT) BROWSE INCDIR(.\source) DEBUG OBJECTEXTEND PR
                    -INT(.\lcd1602.lst) TABS(2) OBJECT(lcd1602.obj)

line level    source

   1          #include "lcd1602.h"
   2          
   3          //**************************************************
   4          //* Internal Func: busy detect
   5          //**************************************************
   6          static void LcdWait (void)
   7          {
   8   1          bit ebk;
   9   1          ebk = EA;
  10   1          EA = 0;
  11   1      
  12   1          // start read
  13   1          PIN_1602_RS     = 0;
  14   1          PIN_1602_RW     = 1;
  15   1          PIN_1602_EN     = 1;
  16   1          DelayUs (0);
  17   1      
  18   1          while (1)
  19   1          {
  20   2      //        PIN_1602_DATA   = 0xFF;
  21   2      #ifdef SIMULATE_ONLY
  22   2              PIN_1602_DATA   = 0x7F;
  23   2      #else
                      PIN_1602_DATA   = 0xFF;
              #endif
  26   2              PIN_1602_EN     = 0;
  27   2              DelayUs (0);
  28   2              PIN_1602_EN     = 1;
  29   2              DelayUs (0);
  30   2              // busy_flag = (bit)(PIN_1602_DATA & 0x80) ;
  31   2              if (!(PIN_1602_DATA & 0x80))
  32   2              {
  33   3                  break;
  34   3              }
  35   2          DelayUs (10); 
  36   2          }  
  37   1      
  38   1          PIN_1602_EN     = 0;
  39   1          EA = ebk;
  40   1      
  41   1      }
  42          
  43          //**************************************************
  44          //* Internal Func: write command
  45          //**************************************************
  46          void LcdWriteCmd (unsigned char cmd)
  47          {
  48   1          bit ebk;
  49   1      
  50   1          // check
  51   1          LcdWait();
  52   1      
  53   1          ebk = EA;
  54   1          EA = 0;
C51 COMPILER V9.52.0.0   LCD1602                                                           01/05/2018 12:35:22 PAGE 2   

  55   1      
  56   1          // write cmd
  57   1          PIN_1602_RS     = 0;
  58   1          PIN_1602_RW     = 0;
  59   1          PIN_1602_EN     = 0;
  60   1          PIN_1602_DATA   = cmd;
  61   1      
  62   1          // pulse
  63   1          PIN_1602_EN     = 1;
  64   1          DelayUs (0);
  65   1          PIN_1602_EN     = 0;
  66   1      
  67   1          EA = ebk;
  68   1      
  69   1          DelayUs (10);
  70   1      }
  71          
  72          //**************************************************
  73          //* Internal Func: write data
  74          //**************************************************
  75          void LcdWriteData (unsigned char dt)
  76          {
  77   1          bit ebk;
  78   1      
  79   1          // check
  80   1          LcdWait();
  81   1      
  82   1          ebk = EA;
  83   1          EA = 0;
  84   1      
  85   1          // write cmd
  86   1          PIN_1602_RS     = 1;
  87   1          PIN_1602_RW     = 0;
  88   1          PIN_1602_EN     = 0;
  89   1          PIN_1602_DATA   = dt;
  90   1          DelayUs (0);
  91   1      
  92   1          // pulse
  93   1          PIN_1602_EN     = 1;
  94   1          DelayUs (0);
  95   1          PIN_1602_EN     = 0;
  96   1      
  97   1          EA = ebk;
  98   1      
  99   1          DelayUs (10);
 100   1      }
 101          
 102          //**************************************************
 103          //* Internal Func: read status
 104          //**************************************************
 105          unsigned char LcdReadStatus (void)
 106          {
 107   1          unsigned char ret;
 108   1          bit ebk;
 109   1          LcdWait ();
 110   1      
 111   1          ebk = EA;
 112   1          EA = 0;
 113   1      
 114   1          // start read
 115   1          PIN_1602_RS     = 0;
 116   1          PIN_1602_RW     = 1;
C51 COMPILER V9.52.0.0   LCD1602                                                           01/05/2018 12:35:22 PAGE 3   

 117   1          PIN_1602_EN     = 1;
 118   1          PIN_1602_DATA   = 0xFF;
 119   1          DelayUs (0);
 120   1          ret = PIN_1602_DATA;
 121   1      
 122   1          PIN_1602_EN     = 0;
 123   1          PIN_1602_RW     = 0;
 124   1      
 125   1          EA = ebk;
 126   1      
 127   1        return ret;
 128   1      }
 129          
 130          //**************************************************
 131          //* Internal Func: read data
 132          //**************************************************
 133          unsigned char LcdReadData (void)
 134          {
 135   1          unsigned char ret;
 136   1          bit ebk;
 137   1          LcdWait ();
 138   1      
 139   1          ebk = EA;
 140   1          EA = 0;
 141   1      
 142   1          // start read
 143   1          PIN_1602_RS     = 1;
 144   1          PIN_1602_RW     = 1;
 145   1          PIN_1602_EN     = 1;
 146   1          PIN_1602_DATA   = 0xFF;
 147   1          _nop_();    _nop_(); 
 148   1          ret = PIN_1602_DATA;
 149   1      
 150   1          PIN_1602_EN     = 0;
 151   1          PIN_1602_RW     = 0;
 152   1      
 153   1          EA = ebk;
 154   1      
 155   1        return ret;
 156   1      }
 157          
 158          //**************************************************
 159          //* Internal Func: AC inc&dec
 160          //**************************************************
 161          void LcdAcInc (void)
 162          {
 163   1          LcdWriteCmd (LCD1602_CMD_MM_14);
 164   1          DelayUs (50);
 165   1      }
 166          
 167          void LcdAcDec (void)
 168          {
 169   1          LcdWriteCmd (LCD1602_CMD_MM_10);
 170   1          DelayUs (50);
 171   1      }
 172          
 173          //**************************************************
 174          //* Func: AC inc&dec
 175          //**************************************************
 176          void LcdWriteOneCGRAM (unsigned char addr, char *pval)
 177          {
 178   1          unsigned char i;
C51 COMPILER V9.52.0.0   LCD1602                                                           01/05/2018 12:35:22 PAGE 4   

 179   1          LcdWriteCmd (0x40 + (addr << 3));
 180   1          for (i = 0; i < 8; i++)
 181   1              LcdWriteData (pval[i]);
 182   1      }
 183          
 184          //**************************************************
 185          //* Func: set position
 186          //**************************************************
 187          void LcdSetPos (unsigned char x, unsigned char y)
 188          {
 189   1          // 1. format parameter
 190   1          x = x & 0x3F;
 191   1          y = y & 0x01;
 192   1      
 193   1          // 2. cal ddram addr
 194   1          if (y) x |= 0x40;
 195   1      
 196   1          // 3. write cmd
 197   1          LcdWriteCmd (x|0x80);
 198   1          DelayUs (50);
 199   1      }
 200          
 201          //**************************************************
 202          //* Func: display char
 203          //**************************************************
 204          void LcdDispChar (unsigned char x, unsigned char y, char c)
 205          {
 206   1          LcdSetPos (x, y);
 207   1          LcdWriteData (c);
 208   1      }
 209          
 210          //**************************************************
 211          //* Func: display string
 212          //**************************************************
 213          void LcdDispString (unsigned char x, unsigned char y, char *ps)
 214          {
 215   1          LcdSetPos (x, y);
 216   1          while (*ps != '\0')
 217   1        {
 218   2              LcdWriteData (*ps);
 219   2          ps++;
 220   2          }
 221   1      }
 222          
 223          //**************************************************
 224          //* Func: display BCD
 225          //**************************************************
 226          void LcdDispBCD (unsigned char x, unsigned char y, unsigned char bcd, unsigned char mode)
 227          {
 228   1          // higher byte
 229   1          LcdSetPos (x, y);
 230   1          if ((bcd & 0xF0) == 0x00)
 231   1          {
 232   2              if ((mode & 0xF0) == 0)
 233   2                  LcdWriteData ('0');
 234   2              else
 235   2                  LcdWriteData (' ');
 236   2          }
 237   1          else
 238   1          {
 239   2              LcdWriteData (((bcd >> 4) & 0x0F) + '0');
 240   2          }
C51 COMPILER V9.52.0.0   LCD1602                                                           01/05/2018 12:35:22 PAGE 5   

 241   1      
 242   1          // lower byte
 243   1          LcdSetPos ((x + 1), y);
 244   1          if ((bcd & 0x0F) == 0x00)
 245   1          {
 246   2              if ((mode & 0x0F) == 0)
 247   2                  LcdWriteData ('0');
 248   2              else
 249   2                  LcdWriteData (' ');
 250   2          }
 251   1          else
 252   1          {
 253   2              LcdWriteData (((bcd) & 0x0F) + '0');
 254   2          }
 255   1      }
 256          
 257          //******************************************************
 258          //* LCD Init
 259          //******************************************************
 260          void LcdInit (void)
 261          {
 262   1          // 1. Bus Mode 38: 8b, 2 lines
 263   1          DelayMs (50);
 264   1          LcdWriteCmd (LCD1602_CMD_BM_38);        // 39us
 265   1          DelayUs (100);
 266   1      
 267   1          // 5. Display Mode 0C: open screen, no cursor, no splash
 268   1          LcdWriteCmd (LCD1602_CMD_DM_0C);
 269   1          DelayUs (100);
 270   1      
 271   1          // 2. Display Mode 08: close screen
 272   1          //LcdWriteCmd (LCD1602_CMD_DM_08);      // 39us
 273   1          //DelayUs (100);
 274   1      
 275   1          // 3. Clear Screen 01
 276   1          LcdWriteCmd (LCD1602_CMD_CLS);          // 1.53ms
 277   1          DelayMs (10);
 278   1      
 279   1          // 4. Enter Mode 06: addr+1, no scroll
 280   1          LcdWriteCmd (LCD1602_CMD_EM_06);        // 39us
 281   1          DelayUs (100);
 282   1      
 283   1          // 5. Display Mode 0C: open screen, no cursor, no splash
 284   1          //LcdWriteCmd (LCD1602_CMD_DM_0C);
 285   1          //DelayUs (250);
 286   1      }
 287          
 288          //**************************************************
 289          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    465    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      14
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       5
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
